/* Copyright (C) YOOtheme GmbH, http://www.gnu.org/licenses/gpl.html GNU/GPL */

!function(e,t){e(function(){e("main.tm-main > .tm-form").append('<div class="tm-form-save"><button type="submit" class="uk-button uk-button-primary js-save-settings">Save changes</button> <span></span></div>');var t=e('input:checkbox[name$="[title]"]');e.each(t,function(){e(this).after(e(this).clone().attr("type","hidden").val(e(this).is(":checked")?"1":"0"))}),t.on("change",function(){e(this).next().val(e(this).is(":checked")?"1":"0")}),e('[data-warp="theme"] .js-save-settings').on("click",function(e){e.preventDefault(),a.save(this)})});var a={save:function(t){var a={},s=e(t);s.attr("disabled",!0).next().attr("class","uk-icon-spinner uk-icon-spin"),parse_str(e(":input","#theme-options").serialize(),a),e.ajax({url:ajaxurl,type:"post",data:{action:"warp_save",config:JSON.stringify(a,null,"\t")},success:function(t){var a=!1;try{t=e.parseJSON(t),"success"==t.message&&(a=!0)}catch(n){}a||alert("Save failed!"),setTimeout(function(){s.attr("disabled",!1).next().attr("class","")},300)}})},saveFiles:function(t){var a=e.Deferred(),s=new FormData;return s.append("action","warp_save_files"),s.append("files",new Blob([window.btoa(unescape(encodeURIComponent(JSON.stringify(t))))],{type:"text/plain"})),e.ajax({url:ajaxurl,type:"POST",data:s,processData:!1,contentType:!1}).always(function(t,s,n){var r=!1;if("error"==s)r=n;else try{t=e.parseJSON(t),"success"!=t.message&&(r=t.message)}catch(i){r="Saving failed!"}a[r?"reject":"resolve"](r)}),a.promise()},data:function(){var t=e.Deferred();return e.ajax({url:ajaxurl,type:"post",data:{action:"warp_get_styles"}}).always(function(a,s,n){var r=!1;if("error"==s)r=n;else try{if(a=e.parseJSON(a),"error"!=a.message)return void t.resolve(a);r=a.message}catch(i){r="Retrieving styles data failed!"}t.reject(r)}),t.promise()}};t.System=a}(jQuery,this);